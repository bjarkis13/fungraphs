<!DOCTYPE html><html>
<head>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<meta charset="utf-8">
	<title>{{ title }}</title>
	<style>
		svg {
				border: 1px solid #ccc;
			}

			.axis line,
			.axis path {
			shape-rendering: crispEdges;
			fill: transparent;
			stroke: #555;
			}
				.axis text {
				font-size: 11px;
			}


			.bar {
				fill-opacity: 0.6;
			}
			.bar.left {
				fill: #e377c2;
					}
			.bar.right {
				fill: #e377c2;
			}
			.bar.all {	
				fill: #1f77b4;	
			}
	</style>
	
	<style>
		#bargraph  {
		  font: 10px sans-serif;
		}

		.y.axis path {
		  display: none;
		}

		.y.axis line {
		  stroke: #fff;
		  stroke-opacity: .2;
		  shape-rendering: crispEdges;
		}

		.y.axis .zero line {
		  stroke: #000;
		  stroke-opacity: 1;
		}

		.title {
		  font: 300 78px Helvetica Neue;
		  fill: #666;
		}

		.birthyear,
		.age {
		  text-anchor: middle;
		}

		.birthyear {
		  fill: #fff;
		}

		rect {
		  fill-opacity: .6;
		  fill: #e377c2;
		}

		rect:first-child {
		  fill: #1f77b4;
		}

	</style>
		
	<!-- Það þarf að skoða style sheet fyrir pop bars -->


</head>

<body>
	<header>
		<h1> {{ title }} </h1>
	</header>

	<div id="agepyramid"> 
		<h2> Age Pyramid </h2>
		<script>
			// SET UP DIMENSIONS
		var w = 500,
		h = 300;

// margin.middle is distance from center line to each y-axis
var margin = {
top: 20,
	 right: 20,
	 bottom: 24,
	 left: 20,
	 middle: 28
};

// the width of each side of the chart
var regionWidth = w/2 - margin.middle;

// these are the x-coordinates of the y-axes
var pointA = regionWidth,
	pointB = w - regionWidth;

// dictionary to create y-axis label
var dic = {20:"100+"};
for(i=0;i<20;i++)
{
	dic[i] = (i*5).toString()+"-"+(i*5+4).toString()
}

// data for the current municipality
var muniData = [
{% for i in gpop %}
{group: dic[{{ i.0 }}], male: {{ i.1 }}, female: {{ i.2 }}},
{% endfor %}
];

// data for all of iceland
var allData = [
{% for i in allgpop %}
{group: dic[{{ i.0 }}], male: {{ i.1 }}, female: {{ i.2 }}},
{% endfor %}
];

// GET THE TOTAL POPULATION SIZE AND CREATE A FUNCTION FOR RETURNING THE PERCENTAGE
var totalMuni = d3.sum(muniData, function(d) { return d.male + d.female; });
var totalAll = d3.sum(allData, function(d) { return d.male + d.female; });
	percentageMuni = function(d) { return d / totalMuni; };
	percentageAll = function(d) { return d / totalAll; };


// CREATE SVG
var svg = d3.select('body').append('svg')
.attr('width', margin.left + w + margin.right)
.attr('height', margin.top + h + margin.bottom)
// ADD A GROUP FOR THE SPACE WITHIN THE MARGINS
.append('g')
.attr('transform', translation(margin.left, margin.top));

// find the maximum data value on either side
//  since this will be shared by both of the x-axes
var maxValue = Math.max(
				d3.max(muniData, function(d) { return percentageMuni(d.male); }),
				d3.max(muniData, function(d) { return percentageMuni(d.female); })
				);

// SET UP SCALES

// the xScale goes from 0 to the width of a region
//  it will be reversed for the left x-axis
		var xScale = d3.scale.linear()
		.domain([0, 0.1])//maxValue])
.range([0, regionWidth])
		.nice();

		var xScaleLeft = d3.scale.linear()
.domain([0, maxValue])
		.range([regionWidth, 0]);

		var xScaleRight = d3.scale.linear()
.domain([0, maxValue])
		.range([0, regionWidth]);

var yScale = d3.scale.ordinal()
		.domain(muniData.map(function(d) { return d.group; }))
		.rangeRoundBands([h,0], 0.1);


		// SET UP AXES
		var yAxisLeft = d3.svg.axis()
.scale(yScale)
		.orient('right')
.tickSize(4,0)
		.tickPadding(margin.middle-4);

		var yAxisRight = d3.svg.axis()
.scale(yScale)
		.orient('left')
.tickSize(4,0)
		.tickFormat('');

		var xAxisRight = d3.svg.axis()
.scale(xScale)
		.orient('bottom')
		.tickFormat(d3.format('%'));


var xAxisLeft = d3.svg.axis()
		// REVERSE THE X-AXIS SCALE ON THE LEFT SIDE BY REVERSING THE RANGE
.scale(xScale.copy().range([pointA, 0]))
		.orient('bottom')
		.tickFormat(d3.format('%'));

		// MAKE GROUPS FOR EACH SIDE OF CHART
		// scale(-1,1) is used to reverse the left side so the bars grow left instead of right
		var leftAllGroup = svg.append('g')
		.attr('transform', translation(pointA, 0) + 'scale(-1,1)');
		var rightAllGroup = svg.append('g')
		.attr('transform', translation(pointB, 0));
		var leftBarGroup = svg.append('g')
		.attr('transform', translation(pointA, 0) + 'scale(-1,1)');
		var rightBarGroup = svg.append('g')
		.attr('transform', translation(pointB, 0));


		// DRAW AXES
		svg.append('g')
		.attr('class', 'axis y left')
		.attr('transform', translation(pointA, 0))
.call(yAxisLeft)
		.selectAll('text')
		.style('text-anchor', 'middle');

		svg.append('g')
		.attr('class', 'axis y right')
		.attr('transform', translation(pointB, 0))
		.call(yAxisRight);

		svg.append('g')
		.attr('class', 'axis x left')
		.attr('transform', translation(0, h))
		.call(xAxisLeft);

		svg.append('g')
		.attr('class', 'axis x right')
		.attr('transform', translation(pointB, h))
		.call(xAxisRight);


		// DRAW BARS
		leftBarGroup.selectAll('.bar.left')
.data(muniData)
		.enter().append('rect')
		.attr('class', 'bar left')
		.attr('x', 0)
		.attr('y', function(d) { return yScale(d.group); })
		.attr('width', function(d) { return xScale(percentageMuni(d.male)); })
		.attr('height', yScale.rangeBand());


		
		leftAllGroup.selectAll('.bar.all')
.data(allData)
		.enter().append('rect')
		.attr('class', 'bar all')
		.attr('x', 0)
		.attr('y', function(d) { return yScale(d.group); })
		.attr('width', function(d) { return xScale(percentageAll(d.male)); })
		.attr('height', yScale.rangeBand());


		rightBarGroup.selectAll('.bar.right')
.data(muniData)
		.enter().append('rect')
		.attr('class', 'bar right')
		.attr('x', 0)
		.attr('y', function(d) { return yScale(d.group); })
		.attr('width', function(d) { return xScale(percentageMuni(d.female)); })
		.attr('height', yScale.rangeBand());


		rightAllGroup.selectAll('.bar.all')
.data(allData)
		.enter().append('rect')
		.attr('class', 'bar all')
		.attr('x', 0)
		.attr('y', function(d) { return yScale(d.group); })
		.attr('width', function(d) { return xScale(percentageAll(d.female)); })
		.attr('height', yScale.rangeBand());

		// so sick of string concatenation for translations
		function translation(x,y) {
				return 'translate(' + x + ',' + y + ')';
								}
		</script>
	<div>

	<div id="gendercolumn">
		<h2> Gender Comparison </h2>


		<script>

var margin = {top: 20, right: 40, bottom: 30, left: 20},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom,
    barWidth = Math.floor(width / 21) - 1;

var x = d3.scale.linear()
    .range([barWidth / 2, width - barWidth / 2]);

var y = d3.scale.linear()
    .range([height, 0]);

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("right")
    .tickSize(-width)
    .tickFormat(function(d) { return Math.round(d); });

// An SVG element with a bottom-right origin.
var svg = d3.select("body").append("svg")
	.attr("class", "bargraph")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// A sliding container to hold the bars by birthyear.
var birthyears = svg.append("g")
    .attr("class", "birthyears");


var data = [
	{% for i in gpop %}
	{
	'people': {{ i.1 }},
	'age' : {{ i.0 }},
	'sex' : 1,
	'year' : {{ i.3 }}
	},
	{
	'people': {{ i.2 }},
	'age' : {{ i.0 }},
	'sex' : 2,
	'year' : {{ i.3 }}
	},
	{% endfor %}
	];

  // Convert strings to numbers.
  data.forEach(function(d) {
    d.people = +d.people;
    d.year = +d.year;
    d.age = (+d.age)*5;
  });

  // Compute the extent of the data set in age and years.
  var age1 = d3.max(data, function(d) { return d.age; }),
      year0 = d3.min(data, function(d) { return d.year; }),
      year1 = d3.max(data, function(d) { return d.year; }),
      year = year1;

  // Update the scale domains.
  x.domain([year1 - age1, year1]);
  y.domain([0, d3.max(data, function(d) { return d.people; })]);

  // Produce a map from year and birthyear to [male, female].
  data = d3.nest()
      .key(function(d) { return d.year; })
      .key(function(d) { return d.year - d.age; })
      .rollup(function(v) { return v.map(function(d) { return d.people; }); })
      .map(data);

  // Add an axis to show the population values.
  svg.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate(" + width + ",0)")
      .call(yAxis)
    .selectAll("g")
    .filter(function(value) { return !value; })
      .classed("zero", true);

  // Add labeled rects for each birthyear (so that no enter or exit is required).
  var birthyear = birthyears.selectAll(".birthyear")
      .data(d3.range(year0 - age1, year1 + 1, 5))
    .enter().append("g")
      .attr("class", "birthyear")
      .attr("transform", function(birthyear) { return "translate(" + x(birthyear) + ",0)"; });

  birthyear.selectAll("rect")
      .data(function(birthyear) { return data[year][birthyear] || [0, 0]; })
    .enter().append("rect")
      .attr("x", -barWidth / 2)
      .attr("width", barWidth)
      .attr("y", y)
      .attr("height", function(value) { return height - y(value); });

  // Add labels to show age (separate; not animated).
  svg.selectAll(".age")
      .data(d3.range(0, age1 + 1, 5))
    .enter().append("text")
      .attr("class", "age")
      .attr("x", function(age) { return x(year - age); })
      .attr("y", height + 4)
      .attr("dy", ".71em")
      .text(function(age) { return age; });

  // Allow the arrow keys to change the displayed year.
  window.focus();
  d3.select(window).on("keydown", function() {
    switch (d3.event.keyCode) {
      case 37: year = Math.max(year0, year - 10); break;
      case 39: year = Math.min(year1, year + 10); break;
    }
    update();
  });

  function update() {
    if (!(year in data)) return;

    birthyears.transition()
        .duration(750)
        .attr("transform", "translate(" + (x(year1) - x(year)) + ",0)");

    birthyear.selectAll("rect")
        .data(function(birthyear) { return data[year][birthyear] || [0, 0]; })
      .transition()
        .duration(750)
        .attr("y", y)
        .attr("height", function(value) { return height - y(value); });
  };

</script>


	<div>

	<div id="lineplot">
		<h2> Population by Year </h2>
	<div> 

	<div id="mergetimeline">
		<h2> Municipality Merges </h2>
	<div>
</body>

</html>
